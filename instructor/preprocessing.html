<!DOCTYPE html>
<!-- START: inst/pkgdown/templates/layout.html --><!-- Generated by pkgdown: do not edit by hand --><html lang="en" data-bs-theme="auto"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><title>Introduction to dMRI: Preprocessing dMRI data</title><meta name="viewport" content="width=device-width, initial-scale=1"><script src="../assets/themetoggle.js"></script><link rel="stylesheet" type="text/css" href="../assets/styles.css"><script src="../assets/scripts.js" type="text/javascript"></script><!-- mathjax --><script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      config: ["MMLorHTML.js"],
      jax: ["input/TeX","input/MathML","output/HTML-CSS","output/NativeMML", "output/PreviewHTML"],
      extensions: ["tex2jax.js","mml2jax.js","MathMenu.js","MathZoom.js", "fast-preview.js", "AssistiveMML.js", "a11y/accessibility-menu.js"],
      TeX: {
        extensions: ["AMSmath.js","AMSsymbols.js","noErrors.js","noUndefined.js"]
      },
      tex2jax: {
        inlineMath: [['\\(', '\\)']],
        displayMath: [ ['$$','$$'], ['\\[', '\\]'] ],
        processEscapes: true
      }
    });
    </script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><!-- Responsive Favicon for The Carpentries --><link rel="apple-touch-icon" sizes="180x180" href="../favicons/incubator/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="../favicons/incubator/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="../favicons/incubator/favicon-16x16.png"><link rel="manifest" href="../favicons/incubator/site.webmanifest"><link rel="mask-icon" href="../favicons/incubator/safari-pinned-tab.svg" color="#5bbad5"><meta name="msapplication-TileColor" content="#da532c"><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="black"></head><body>
    <header id="top" class="navbar navbar-expand-md top-nav incubator"><svg xmlns="http://www.w3.org/2000/svg" class="d-none"><symbol id="check2" viewbox="0 0 16 16"><path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0z"></path></symbol><symbol id="circle-half" viewbox="0 0 16 16"><path d="M8 15A7 7 0 1 0 8 1v14zm0 1A8 8 0 1 1 8 0a8 8 0 0 1 0 16z"></path></symbol><symbol id="moon-stars-fill" viewbox="0 0 16 16"><path d="M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z"></path><path d="M10.794 3.148a.217.217 0 0 1 .412 0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217 0 0 1 0 .412l-1.162.387a1.734 1.734 0 0 0-1.097 1.097l-.387 1.162a.217.217 0 0 1-.412 0l-.387-1.162A1.734 1.734 0 0 0 9.31 6.593l-1.162-.387a.217.217 0 0 1 0-.412l1.162-.387a1.734 1.734 0 0 0 1.097-1.097l.387-1.162zM13.863.099a.145.145 0 0 1 .274 0l.258.774c.115.346.386.617.732.732l.774.258a.145.145 0 0 1 0 .274l-.774.258a1.156 1.156 0 0 0-.732.732l-.258.774a.145.145 0 0 1-.274 0l-.258-.774a1.156 1.156 0 0 0-.732-.732l-.774-.258a.145.145 0 0 1 0-.274l.774-.258c.346-.115.617-.386.732-.732L13.863.1z"></path></symbol><symbol id="sun-fill" viewbox="0 0 16 16"><path d="M8 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z"></path></symbol></svg><a class="visually-hidden-focusable skip-link" href="#main-content">Skip to main content</a>
  <div class="container-fluid top-nav-container">
    <div class="col-md-8">
      <div class="large-logo">
        <img id="incubator-logo" alt="Carpentries Incubator" src="../assets/images/incubator-logo.svg"><span class="badge text-bg-danger">
          <abbr title="This lesson is in the pre-alpha phase, which means that it is in early development, but has not yet been taught.">
            <a href="https://cdh.carpentries.org/the-lesson-life-cycle.html#early-development-pre-alpha-through-alpha" class="external-link alert-link">
              <i aria-hidden="true" class="icon" data-feather="alert-octagon" style="border-radius: 5px"></i>
              Pre-Alpha
            </a>
            <span class="visually-hidden">This lesson is in the pre-alpha phase, which means that it is in early development, but has not yet been taught.</span>
          </abbr>
        </span>

      </div>
    </div>
    <div class="selector-container">
      <div id="theme-selector">
        <li class="nav-item dropdown" id="theme-button-list">
          <button class="btn btn-link nav-link px-0 px-lg-2 dropdown-toggle d-flex align-items-center" id="bd-theme" type="button" aria-expanded="false" data-bs-toggle="dropdown" data-bs-display="static" aria-label="Toggle theme (auto)">
            <svg class="bi my-1 theme-icon-active"><use href="#circle-half"></use></svg><i data-feather="chevron-down"></i>
          </button>
          <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="bd-theme-text"><li>
              <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="light" aria-pressed="false">
                <svg class="bi me-2 theme-icon"><use href="#sun-fill"></use></svg>
                Light
                <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
            </li>
            <li>
              <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="dark" aria-pressed="false">
                <svg class="bi me-2 theme-icon"><use href="#moon-stars-fill"></use></svg>
                Dark
                <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
            </li>
            <li>
              <button type="button" class="btn dropdown-item d-flex align-items-center active" data-bs-theme-value="auto" aria-pressed="true">
                <svg class="bi me-2 theme-icon"><use href="#circle-half"></use></svg>
                Auto
                <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
            </li>
          </ul></li>
      </div>

      <div class="dropdown" id="instructor-dropdown">
        <button class="btn btn-secondary dropdown-toggle bordered-button" type="button" id="dropdownMenu1" data-bs-toggle="dropdown" aria-expanded="false">
          <i aria-hidden="true" class="icon" data-feather="eye"></i> Instructor View <i data-feather="chevron-down"></i>
        </button>
        <ul class="dropdown-menu" aria-labelledby="dropdownMenu1"><li><button class="dropdown-item" type="button" onclick="window.location.href='../preprocessing.html';">Learner View</button></li>
        </ul></div>
    </div>
  </div>
  <hr></header><nav class="navbar navbar-expand-xl bottom-nav incubator" aria-label="Main Navigation"><div class="container-fluid nav-container">
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle Navigation">
      <span class="navbar-toggler-icon"></span>
      <span class="menu-title">Menu</span>
    </button>
    <div class="nav-logo">
      <img class="small-logo" alt="Carpentries Incubator" src="../assets/images/incubator-logo-sm.svg"></div>
    <div class="lesson-title-md">
      Introduction to dMRI
    </div>
    <div class="search-icon-sm">
      <!-- TODO: do not show until we have search
        <i role="img" aria-label="Search the All In One page" data-feather="search"></i>
      -->
    </div>
    <div class="desktop-nav">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0"><li class="nav-item">
          <span class="lesson-title">
            Introduction to dMRI
          </span>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="../instructor/key-points.html">Key Points</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="../instructor/instructor-notes.html">Instructor Notes</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="../instructor/images.html">Extract All Images</a>
        </li>
        <li class="nav-item dropdown">
          <button class="nav-link dropdown-toggle" id="navbarDropdown" data-bs-toggle="dropdown" aria-expanded="false">
            More <i data-feather="chevron-down"></i>
          </button>
          <ul class="dropdown-menu" aria-labelledby="navbarDropdown"><hr><li><a class="dropdown-item" href="discuss.html">Discussion</a></li><li><a class="dropdown-item" href="reference.html">Glossary</a></li>
          </ul></li>
      </ul></div>
    <!--
    <form class="d-flex col-md-2 search-form">
      <fieldset disabled>
      <input class="form-control me-2 searchbox" type="search" placeholder="" aria-label="">
        <button class="btn btn-outline-success tablet-search-button"  type="submit">
          <i class="search-icon" data-feather="search" role="img" aria-label="Search the All In One page"></i>
        </button>
      </fieldset>
    </form>
    -->
    <a id="search-button" class="btn btn-primary" href="../instructor/aio.html" role="button" aria-label="Search the All In One page">Search the All In One page</a>
  </div><!--/div.container-fluid -->
</nav><div class="col-md-12 mobile-title">
  Introduction to dMRI
</div>

<aside class="col-md-12 lesson-progress"><div style="width: 5%" class="percentage">
    5%
  </div>
  <div class="progress incubator">
    <div class="progress-bar incubator" role="progressbar" style="width: 5%" aria-valuenow="5" aria-label="Lesson Progress" aria-valuemin="0" aria-valuemax="100">
    </div>
  </div>
</aside><div class="container">
      <div class="row">
        <!-- START: inst/pkgdown/templates/navbar.html -->
<div id="sidebar-col" class="col-lg-4">
  <div id="sidebar" class="sidebar">
      <nav aria-labelledby="flush-headingEleven"><button role="button" aria-label="close menu" alt="close menu" aria-expanded="true" aria-controls="sidebar" class="collapse-toggle" data-collapse="Collapse " data-episodes="Episodes ">
          <i class="search-icon" data-feather="x" role="img"></i>
        </button>
        <div class="sidebar-inner">
          <div class="row mobile-row" id="theme-row-mobile">
            <div class="col" id="theme-selector">
              <li class="nav-item dropdown" id="theme-button-list">
                <button class="btn btn-link nav-link px-0 px-lg-2 dropdown-toggle d-flex align-items-center" id="bd-theme" type="button" aria-expanded="false" data-bs-toggle="dropdown" data-bs-display="static" aria-label="Toggle theme (auto)">
                  <svg class="bi my-1 theme-icon-active"><use href="#circle-half"></use></svg><span class="d-lg-none ms-1" id="bd-theme-text">Toggle Theme</span>
                </button>
                <ul class="dropdown-menu dropdown-menu-right" aria-labelledby="bd-theme-text"><li>
                    <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="light" aria-pressed="false">
                      <svg class="bi me-2 theme-icon"><use href="#sun-fill"></use></svg>
                      Light
                      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
                  </li>
                  <li>
                    <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="dark" aria-pressed="false">
                      <svg class="bi me-2 theme-icon"><use href="#moon-stars-fill"></use></svg>
                      Dark
                      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
                  </li>
                  <li>
                    <button type="button" class="btn dropdown-item d-flex align-items-center active" data-bs-theme-value="auto" aria-pressed="true">
                      <svg class="bi me-2 theme-icon"><use href="#circle-half"></use></svg>
                      Auto
                      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
                  </li>
                </ul></li>
            </div>
          </div>
          <div class="row mobile-row">
            <div class="col">
              <div class="sidenav-view-selector">
                <div class="accordion accordion-flush" id="accordionFlush9">
                  <div class="accordion-item">
                    <h2 class="accordion-header" id="flush-headingNine">
                      <button class="accordion-button collapsed" id="instructor" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseNine" aria-expanded="false" aria-controls="flush-collapseNine">
                        <i id="eye" aria-hidden="true" class="icon" data-feather="eye"></i> Instructor View
                      </button>
                    </h2>
                    <div id="flush-collapseNine" class="accordion-collapse collapse" aria-labelledby="flush-headingNine" data-bs-parent="#accordionFlush2">
                      <div class="accordion-body">
                        <a href="../preprocessing.html">Learner View</a>
                      </div>
                    </div>
                  </div><!--/div.accordion-item-->
                </div><!--/div.accordion-flush-->
              </div><!--div.sidenav-view-selector -->
            </div><!--/div.col -->

            <hr></div><!--/div.mobile-row -->

          <div class="accordion accordion-flush" id="accordionFlush11">
            <div class="accordion-item">

              <button id="chapters" class="accordion-button show" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseEleven" aria-expanded="false" aria-controls="flush-collapseEleven">
                <h2 class="accordion-header chapters" id="flush-headingEleven">
                  EPISODES
                </h2>
              </button>
              <div id="flush-collapseEleven" class="accordion-collapse show collapse" aria-labelledby="flush-headingEleven" data-bs-parent="#accordionFlush11">

                <div class="accordion-body">
                  <div class="accordion accordion-flush" id="accordionFlush1">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading1">
        <a href="index.html">Summary and Schedule</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush2">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading2">
        <a href="introduction.html">1. Introduction to Diffusion MRI data</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlushcurrent">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-headingcurrent">
      <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapsecurrent" aria-expanded="true" aria-controls="flush-collapsecurrent">
        <span class="visually-hidden">Current Chapter</span>
        <span class="current-chapter">
        2. Preprocessing dMRI data
        </span>
      </button>
    </div><!--/div.accordion-header-->

    <div id="flush-collapsecurrent" class="accordion-collapse collapse show" aria-labelledby="flush-headingcurrent" data-bs-parent="#accordionFlushcurrent">
      <div class="accordion-body">
        <ul><li><a href="#diffusion-preprocessing">Diffusion Preprocessing</a></li>
        </ul></div><!--/div.accordion-body-->
    </div><!--/div.accordion-collapse-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush4">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading4">
        <a href="local_orientation_reconstruction.html">3. Local fiber orientation reconstruction</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush5">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading5">
        <a href="diffusion_tensor_imaging.html">4. Diffusion Tensor Imaging (DTI)</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush6">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading6">
        <a href="constrained_spherical_deconvolution.html">5. Constrained Spherical Deconvolution (CSD)</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush7">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading7">
        <a href="tractography.html">6. Tractography</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush8">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading8">
        <a href="local_tractography.html">7. Local tractography</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush9">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading9">
        <a href="deterministic_tractography.html">8. Deterministic tractography</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush10">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading10">
        <a href="probabilistic_tractography.html">9. Probabilistic tractography</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

                </div>
              </div>
            </div>

            <hr class="half-width"><div class="accordion accordion-flush lesson-resources" id="accordionFlush12">
              <div class="accordion-item">
                <h2 class="accordion-header" id="flush-headingTwelve">
                  <button class="accordion-button collapsed" id="lesson-resources" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseTwelve" aria-expanded="false" aria-controls="flush-collapseTwelve">
                    RESOURCES
                  </button>
                </h2>
                <div id="flush-collapseTwelve" class="accordion-collapse collapse" aria-labelledby="flush-headingTwelve" data-bs-parent="#accordionFlush12">
                  <div class="accordion-body">
                    <ul><li>
                        <a href="../instructor/key-points.html">Key Points</a>
                      </li>
                      <li>
                        <a href="../instructor/instructor-notes.html">Instructor Notes</a>
                      </li>
                      <li>
                        <a href="../instructor/images.html">Extract All Images</a>
                      </li>
                      <hr><li><a class="dropdown-item" href="discuss.html">Discussion</a></li><li><a class="dropdown-item" href="reference.html">Glossary</a></li>
                    </ul></div>
                </div>
              </div>
            </div>
            <hr class="half-width lesson-resources"><a href="../instructor/aio.html">See all in one page</a>


            <hr class="d-none d-sm-block d-md-none"><div class="d-grid gap-1">

            </div>
          </div><!-- /div.accordion -->
        </div><!-- /div.sidebar-inner -->
      </nav></div><!-- /div.sidebar -->
  </div><!-- /div.sidebar-col -->
<!-- END:   inst/pkgdown/templates/navbar.html-->

        <!-- START: inst/pkgdown/templates/content-instructor.html -->
  <div class="col-xl-8 col-lg-12 primary-content">
    <nav class="lesson-content mx-md-4" aria-label="Previous and Next Chapter"><!-- content for small screens --><div class="d-block d-sm-block d-md-none">
        <a class="chapter-link" href="../instructor/introduction.html"><i aria-hidden="true" class="small-arrow" data-feather="arrow-left"></i>Previous</a>
        <a class="chapter-link float-end" href="../instructor/local_orientation_reconstruction.html">Next<i aria-hidden="true" class="small-arrow" data-feather="arrow-right"></i></a>
      </div>
      <!-- content for large screens -->
      <div class="d-none d-sm-none d-md-block">
        <a class="chapter-link" href="../instructor/introduction.html" rel="prev">
          <i aria-hidden="true" class="small-arrow" data-feather="arrow-left"></i>
          Previous: Introduction to
        </a>
        <a class="chapter-link float-end" href="../instructor/local_orientation_reconstruction.html" rel="next">
          Next: Local fiber...
          <i aria-hidden="true" class="small-arrow" data-feather="arrow-right"></i>
        </a>
      </div>
      <hr></nav><main id="main-content" class="main-content"><div class="container lesson-content">
        <h1>Preprocessing dMRI data</h1>
        <p>Last updated on 2024-02-18 |

        <a href="https://github.com/carpentries-incubator/SDC-BIDS-dMRI/edit/main/episodes/preprocessing.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>



        <p>Estimated time: <i aria-hidden="true" data-feather="clock"></i> 30 minutes</p>

        <div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>

        

<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul><li>What are the standard preprocessing steps?</li>
<li>How do we register with an anatomical image?</li>
</ul></div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul><li>Understand the common preprocessing steps</li>
<li>Learn to register diffusion data</li>
</ul></div>
</div>
</div>
</div>
</div>
<section><h2 class="section-heading" id="diffusion-preprocessing">Diffusion Preprocessing<a class="anchor" aria-label="anchor" href="#diffusion-preprocessing"></a></h2>
<hr class="half-width"><p>Diffusion MRI data does not typically come off the scanner ready to
be analyzed, and there can be many things that might need to be
corrected before analysis. Diffusion preprocessing typically comprises
of a series of steps to perform the necessary corrections to the data.
These steps may vary depending on how the data is acquired. Some
consensus has been reached for certain preprocessing steps, while others
are still up for debate. The lesson will primarily focus on the
preprocessing steps where consensus has been reached. Preprocessing is
performed using a few well-known software packages (e.g. <a href="https://fsl.fmrib.ox.ac.uk/fsl/fslwiki" class="external-link">FSL</a>, <a href="https://github.com/ANTsX/ANTs" class="external-link">ANTs</a>. For the purposes of these
lessons, preprocessing steps requiring these software packages has
already been performed for the dataset <code>ds000221</code> and the
commands required for each step will be provided. This dataset contains
single shell diffusion data with 7 <span class="math inline">\(b = 0
s/mm^2\)</span> volumes (non-diffusion weighted) and 60 <span class="math inline">\(b = 1000 s/mm^2\)</span> volumes. In addition,
field maps (found in the <code>fmap</code> directory are acquired with
opposite phase-encoding directions).</p>
<p>To illustrate what the preprocessing step may look like, here is an
example preprocessing workflow from QSIPrep (Cieslak <em>et al</em>,
2020): <img src="../fig/preprocessing/preprocess_steps.jpg" alt="Preprocessing steps" class="figure"></p>
<p>dMRI has some similar challenges to fMRI preprocessing, as well as
some unique <a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3366862/" class="external-link">ones</a>.</p>
<p>Our preprocesssing of this data will consist of following steps:</p>
<ol style="list-style-type: decimal"><li>Brainmasking the diffusion data.</li>
<li>Applying <code>FSL</code> <code>topup</code> to correct for
susceptibility induced distortions.</li>
<li>
<code>FSL</code> Eddy current distortion correction.</li>
<li>Registration to T1w.</li>
</ol><p>The same subject (<code>sub-010006</code>) will be used throughout
the remainder of the lesson.</p>
<div class="section level3">
<h3 id="brainmasking">Brainmasking<a class="anchor" aria-label="anchor" href="#brainmasking"></a></h3>
<p>The first step to the preprocessing workflow is to create an
appropriate brainmask from the diffusion data! Start by first importing
the necessary modules and reading the diffusion data along with the
coordinate system (the affine)! We will also grab the anatomical T1w
image to use later on, as well as the second inversion from the
anatomical acquisition for brainmasking purposes.</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="im">from</span> bids.layout <span class="im">import</span> BIDSLayout</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a>layout <span class="op">=</span> BIDSLayout(<span class="st">"../../data/ds000221"</span>, validate<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a>subj<span class="op">=</span><span class="st">'010006'</span></span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" tabindex="-1"></a><span class="co"># Diffusion data</span></span>
<span id="cb1-8"><a href="#cb1-8" tabindex="-1"></a>dwi <span class="op">=</span> layout.get(subject<span class="op">=</span>subj, suffix<span class="op">=</span><span class="st">'dwi'</span>, extension<span class="op">=</span><span class="st">'.nii.gz'</span>, return_type<span class="op">=</span><span class="st">'file'</span>)[<span class="dv">0</span>]</span>
<span id="cb1-9"><a href="#cb1-9" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" tabindex="-1"></a><span class="co"># Anatomical data</span></span>
<span id="cb1-11"><a href="#cb1-11" tabindex="-1"></a>t1w <span class="op">=</span> layout.get(subject<span class="op">=</span>subj, suffix<span class="op">=</span><span class="st">'T1w'</span>, extension<span class="op">=</span><span class="st">'.nii.gz'</span>, return_type<span class="op">=</span><span class="st">'file'</span>)[<span class="dv">0</span>]</span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a><span class="im">import</span> nibabel <span class="im">as</span> nib</span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a>dwi <span class="op">=</span> nib.load(dwi)</span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a>dwi_affine <span class="op">=</span> dwi.affine</span>
<span id="cb2-6"><a href="#cb2-6" tabindex="-1"></a>dwi_data <span class="op">=</span> dwi.get_fdata()</span></code></pre>
</div>
<p><code>DIPY</code>’s <code>segment.mask</code> module will be used to
create a brainmask from this. This module contains a function
<code>median_otsu</code>, which can be used to segment the brain and
provide a binary brainmask! Here, a brainmask will be created using the
first non-diffusion volume of the data. We will save this brainmask to
be used in our later future preprocessing steps. After creating the
brainmask, we will start to correct for distortions in our images.</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a><span class="im">from</span> dipy.segment.mask <span class="im">import</span> median_otsu</span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a><span class="co"># vol_idx is a 1D-array containing the index of the first b0</span></span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a>dwi_brain, dwi_mask <span class="op">=</span> median_otsu(dwi_data, vol_idx<span class="op">=</span>[<span class="dv">0</span>])</span>
<span id="cb3-6"><a href="#cb3-6" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" tabindex="-1"></a><span class="co"># Create necessary folders to save mask</span></span>
<span id="cb3-8"><a href="#cb3-8" tabindex="-1"></a>out_dir <span class="op">=</span> <span class="ss">f'../../data/ds000221/derivatives/uncorrected/sub-</span><span class="sc">{</span>subj<span class="sc">}</span><span class="ss">/ses-01/dwi/'</span></span>
<span id="cb3-9"><a href="#cb3-9" tabindex="-1"></a></span>
<span id="cb3-10"><a href="#cb3-10" tabindex="-1"></a><span class="co"># Check to see if directory exists, if not create one</span></span>
<span id="cb3-11"><a href="#cb3-11" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(out_dir):</span>
<span id="cb3-12"><a href="#cb3-12" tabindex="-1"></a>    os.makedirs(out_dir)</span>
<span id="cb3-13"><a href="#cb3-13" tabindex="-1"></a></span>
<span id="cb3-14"><a href="#cb3-14" tabindex="-1"></a>img <span class="op">=</span> nib.Nifti1Image(dwi_mask.astype(np.float32), dwi_affine)</span>
<span id="cb3-15"><a href="#cb3-15" tabindex="-1"></a>nib.save(img, os.path.join(out_dir, <span class="ss">f"sub-</span><span class="sc">{</span>subj<span class="sc">}</span><span class="ss">_ses-01_brainmask.nii.gz"</span>))</span></code></pre>
</div>
<figure><img src="../fig/preprocessing/dwi_brainmask.png" alt="b0 brainmask" class="figure mx-auto d-block"></figure></div>
<div class="section level3">
<h3 id="fsl-topup">
<code>FSL</code> <a href="https://fsl.fmrib.ox.ac.uk/fsl/fslwiki/topup" class="external-link"><code>topup</code></a>
<a class="anchor" aria-label="anchor" href="#fsl-topup"></a></h3>
<p>Diffusion images, typically acquired using spin-echo echo planar
imaging (EPI), are sensitive to non-zero off-resonance fields. One
source of these fields is from the susceptibility distribution of the
subjects head, otherwise known as susceptibility-induced off-resonance
field. This field is approximately constant for all acquired diffusion
images. As such, for a set of diffusion volumes, the
susceptibility-induced field will be consistent throughout. This is
mainly a problem due to geometric mismatches with the anatomical images
(e.g. T1w), which are typically unaffected by such distortions.</p>
<p><code>topup</code>, part of the <code>FSL</code> library, estimates
and attempts to correct the susceptibility-induced off-resonance field
by using 2 (or more) acquisitions, where the acquisition parameters
differ such that the distortion differs. Typically, this is done using
two acquisitions acquired with opposite phase-encoding directions, which
results in the same field creating distortions in opposing
directions.</p>
<p><img src="../fig/preprocessing/blip_up_blip_down.png" alt="Blip up and blip down pairs" class="figure"><br>
Opposite phase-encodings from two DWI</p>
<p>Here, we will make use of the two opposite phase-encoded acquisitions
found in the <code>fmap</code> directory of each subject. These are
acquired with a diffusion weighting of <span class="math inline">\(b = 0
s/mm^2\)</span>. Alternatively, if these are not available, one can also
extract and make use of the non-diffusion weighted images (assuming the
data is also acquired with opposite phase encoding directions).</p>
<p>First, we will merge the two files so that all of the volumes are in
1 file.</p>
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="fu">mkdir</span> <span class="at">-p</span> ../../data/ds000221/derivatives/uncorrected_topup/sub-010006/ses-01/dwi/work</span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a><span class="ex">fslmerge</span> <span class="at">-t</span> ../../data/ds000221/derivatives/uncorrected_topup/sub-010006/ses-01/dwi/work/sub-010006_ses-01_acq-SEfmapDWI_epi.nii.gz ../../data/ds000221/sub-010006/ses-01/fmap/sub-010006_ses-01_acq-SEfmapDWI_dir-AP_epi.nii.gz ../../data/ds000221/sub-010006/ses-01/fmap/sub-010006_ses-01_acq-SEfmapDWI_dir-PA_epi.nii.gz</span></code></pre>
</div>
<p>Another file we will need to create is a text file containing the
information about how the volumes were acquired. Each line in this file
will pertain to a single volume in the merged file. The first 3 values
of each line refers to the acquisition direction, typically along the
y-axis (or anterior-posterior). The final value is the total readout
time (from center of first echo to center of final echo), which can be
determined from values contained within the associated JSON metadata
file (named “JSON sidecar file” within the BIDS specification). Each
line will look similar to <code>[x y z TotalReadoutTime]</code>. In this
case, the file, which we created, is contained within the
<code>pedir.txt</code> file in the derivative directory.</p>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="ex">0</span> 1 0 0.04914</span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a><span class="ex">0</span> 1 0 0.04914</span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a><span class="ex">0</span> 1 0 0.04914</span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a><span class="ex">0</span> <span class="at">-1</span> 0 0.04914</span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a><span class="ex">0</span> <span class="at">-1</span> 0 0.04914</span>
<span id="cb5-6"><a href="#cb5-6" tabindex="-1"></a><span class="ex">0</span> <span class="at">-1</span> 0 0.04914</span></code></pre>
</div>
<p>With these two inputs, the next step is to make the call to
<code>topup</code> to estimate the susceptibility-induced field. Within
the call, a few parameters are used. Briefly:</p>
<ul><li>
<code>--imain</code> specifies the previously merged volume.</li>
<li>
<code>--datain</code> specifies the text file containing the
information regarding the acquisition.</li>
<li>
<code>--config=b02b0.cnf</code> makes use of a predefined config
file. supplied with <code>topup</code>, which contains parameters useful
to registering with good <span class="math inline">\(b = 0
s/mm^2\)</span> images.</li>
<li>
<code>--out</code> defines the output files containing the spline.
coefficients for the induced field, as well as subject movement
parameters.</li>
</ul><div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="ex">topup</span> <span class="at">--imain</span><span class="op">=</span>../../data/ds000221/derivatives/topup/sub-010006/ses-01/dwi/work/sub-010006_ses-01_acq-SEfmapDWI_epi.nii.gz <span class="at">--datain</span><span class="op">=</span>../../data/ds000221/derivatives/topup/sub-010006/ses-01/dwi/work/pedir.txt <span class="at">--config</span><span class="op">=</span>b02b0.cnf <span class="at">--out</span><span class="op">=</span>../../data/ds000221/derivatives/topup/sub-010006/ses-01/dwi/work/topup</span></code></pre>
</div>
<p>Next, we can apply the correction to the entire diffusion weighted
volume by using <code>applytopup</code> Similar to <code>topup</code>, a
few parameters are used. Briefly:</p>
<ul><li>
<code>--imain</code> specifies the input diffusion weighted
volume.</li>
<li>
<code>--datain</code> again specifies the text file containing
information regarding the acquisition - same file previously used.</li>
<li>
<code>--inindex</code> specifies the index (comma separated list) of
the input image to be corrected.</li>
<li>
<code>--topup</code> name of field/movements (from previous topup
step.</li>
<li>
<code>--out</code> basename for the corrected output image.</li>
<li>
<code>--method</code> (optional) jacobian modulation (jac) or
least-squares resampling (lsr).</li>
</ul><div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="ex">applytopup</span> <span class="at">--imain</span><span class="op">=</span>../../data/ds000221/sub-010006/ses-01/dwi/sub-010006_ses-01_dwi.nii.gz <span class="at">--datain</span><span class="op">=</span>../../data/ds000221/derivatives/topup/sub-010006/ses-01/dwi/work/pedir.txt <span class="at">--inindex</span><span class="op">=</span>1 <span class="at">--topup</span><span class="op">=</span>../../data/ds000221/derivatives/topup/sub-010006/ses-01/dwi/work/topup <span class="at">--out</span><span class="op">=</span>../../data/ds000221/derivatives/topup/sub-010006/ses-01/dwi/dwi <span class="at">--method</span><span class="op">=</span>jac</span></code></pre>
</div>
<figure><img src="../fig/preprocessing/dwi_topup.png" alt="Topup image" class="figure mx-auto d-block"></figure></div>
<div class="section level3">
<h3 id="fsl-eddy">
<code>FSL</code> <a href="https://fsl.fmrib.ox.ac.uk/fsl/fslwiki/eddy" class="external-link"><code>Eddy</code></a>
<a class="anchor" aria-label="anchor" href="#fsl-eddy"></a></h3>
<p>Another source of the non-zero off resonance fields is caused by the
rapid switching of diffusion weighting gradients, otherwise known as
eddy current-induced off-resonance fields. Additionally, the subject is
likely to move during the diffusion protocol, which may be lengthy.</p>
<p><code>eddy</code>, also part of the <code>FSL</code> library,
attempts to correct for both eddy current-induced fields and subject
movement by reading the gradient table and estimating the distortion
volume by volume. This tool is also able to optionally detect and
replace outlier slices.</p>
<p>Here, we will demonstrate the application of <code>eddy</code>
following the <code>topup</code> correction step, by making use of both
the uncorrected diffusion data, as well as estimated warpfield from the
<code>topup</code>. Additionally, a text file, which maps each of the
volumes to one of the corresponding acquisition directions from the
<code>pedir.txt</code> file will have to be created. Finally, similar to
<code>topup</code>, there are also a number of input parameters which
have to be specified:</p>
<ul><li>
<code>--imain</code> specifies the undistorted diffusion weighted
volume.</li>
<li>
<code>--mask</code> specifies the brainmask for the undistorted
diffusion weighted volume.</li>
<li>
<code>--acqp</code> specifies the the text file containing
information regarding the acquisition that was previously used in
<code>topup</code>.</li>
<li>
<code>--index</code> is the text file which maps each diffusion
volume to the corresponding acquisition direction.</li>
<li>
<code>--bvecs</code> specifies the bvec file to the undistorted
dwi.</li>
<li>
<code>--bvals</code> similarily specifies the bval file to the
undistorted dwi.</li>
<li>
<code>--topup</code> specifies the directory and distortion
correction files previously estimated by <code>topup</code>.</li>
<li>
<code>--out</code> specifies the prefix of the output files
following eddy correction.</li>
<li>
<code>--repol</code> is a flag, which specifies replacement of
outliers.</li>
</ul><div class="codewrapper sourceCode" id="cb8">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="fu">mkdir</span> <span class="at">-p</span> ../../data/ds000221/derivatives/uncorrected_topup_eddy/sub-010006/ses-01/dwi/work</span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a><span class="co"># Create an index file mapping the 67 volumes in 4D dwi volume to the pedir.txt file</span></span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a><span class="va">indx</span><span class="op">=</span><span class="st">""</span></span>
<span id="cb8-5"><a href="#cb8-5" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="kw">`</span><span class="fu">seq</span> 1 67<span class="kw">`;</span> <span class="cf">do</span></span>
<span id="cb8-6"><a href="#cb8-6" tabindex="-1"></a>  <span class="va">indx</span><span class="op">=</span><span class="st">"</span><span class="va">$indx</span><span class="st"> 1"</span></span>
<span id="cb8-7"><a href="#cb8-7" tabindex="-1"></a><span class="cf">done</span></span>
<span id="cb8-8"><a href="#cb8-8" tabindex="-1"></a><span class="bu">echo</span> <span class="va">$indx</span> <span class="op">&gt;</span> ../../data/ds000221/derivatives/uncorrected_topup_eddy/sub-010006/ses-01/dwi/work/index.txt</span>
<span id="cb8-9"><a href="#cb8-9" tabindex="-1"></a></span>
<span id="cb8-10"><a href="#cb8-10" tabindex="-1"></a><span class="ex">eddy</span> <span class="at">--imain</span><span class="op">=</span>../../data/ds000221/sub-010006/ses-01/dwi/sub-010006_ses-01_dwi.nii.gz <span class="at">--mask</span><span class="op">=</span>../../data/ds000221/derivatives/uncorrected/sub-010006/ses-01/dwi/sub-010006_ses-01_brainmask.nii.gz <span class="at">--acqp</span><span class="op">=</span>../../data/ds000221/derivatives/uncorrected_topup/sub-010006/ses-01/dwi/work/pedir.txt <span class="at">--index</span><span class="op">=</span>../../data/ds000221/derivatives/uncorrected_topup_eddy/sub-010006/ses-01/dwi/work/index.txt <span class="at">--bvecs</span><span class="op">=</span>../../data/ds000221/sub-010006/ses-01/dwi/sub-010006_ses-01_dwi.bvec <span class="at">--bvals</span><span class="op">=</span>../../data/ds000221/sub-010006/ses-01/dwi/sub-010006_ses-01_dwi.bval <span class="at">--topup</span><span class="op">=</span>../../data/ds000221/derivatives/uncorrected_topup/sub-010006/ses-01/dwi/work/topup <span class="at">--out</span><span class="op">=</span>../../data/ds000221/derivatives/uncorrected_topup_eddy/sub-010006/ses-01/dwi/dwi <span class="at">--repol</span></span></code></pre>
</div>
</div>
<div class="section level3">
<h3 id="registration-with-t1w">Registration with T1w<a class="anchor" aria-label="anchor" href="#registration-with-t1w"></a></h3>
<p>The final step to our diffusion processing is registration to an
anatomical image (e.g. T1-weighted). This is important because the
diffusion data, typically acquired using echo planar imaging or EPI,
enables faster acquisitions at the cost of lower resolution and
introduction of distortions (as seen above). Registration with the
anatomical image not only helps to correct for some distortions, it also
provides us with a higher resolution, anatomical reference.</p>
<p>First, we will create a brainmask of the anatomical image using the
anatomical acquisition (e.g. T1-weighted). To do this, we will use
<code>FSL</code> <code>bet</code> twice. The first call to
<code>bet</code> will create a general skullstripped brain. Upon
inspection, we can note that there is still some residual areas of the
image which were included in the first pass. Calling <code>bet</code> a
second time, we get a better outline of the brain and brainmask, which
we can use for further processing.</p>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="fu">mkdir</span> <span class="at">-p</span> ../../data/ds000221/derivatives/uncorrected/sub-010006/ses-01/anat</span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a><span class="ex">bet</span> ../../data/ds000221/sub-010006/ses-01/anat/sub-010006_ses-01_inv-2_mp2rage.nii.gz ../../data/ds000221/derivatives/uncorrected/sub-010006/ses-01/anat/sub-010006_ses-01_space-T1w_broadbrain <span class="at">-f</span> 0.6</span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a><span class="ex">bet</span> ../../data/ds000221/derivatives/uncorrected/sub-010006/ses-01/anat/sub-010006_ses-01_space-T1w_broadbrain ../../data/ds000221/derivatives/uncorrected/sub-010006/ses-01/anat/sub-010006_ses-01_space-T1w_brain <span class="at">-f</span> 0.4 <span class="at">-m</span></span>
<span id="cb9-5"><a href="#cb9-5" tabindex="-1"></a></span>
<span id="cb9-6"><a href="#cb9-6" tabindex="-1"></a><span class="fu">mv</span> ../../data/ds000221/derivatives/uncorrected/sub-010006/ses-01/anat/sub-010006_ses-01_space-T1w_brain_mask.nii.gz ../../data/ds000221/derivatives/uncorrected/sub-010006/ses-01/anat/sub-010006_ses-01_space-T1w_brainmask.nii.gz</span></code></pre>
</div>
<figure><img src="../fig/preprocessing/T1w_brainmask.png" alt="T1w brainmask" class="figure mx-auto d-block"></figure><p>Note, we use <code>bet</code> here, as well as the second inversion
of the anatomical image, as it provides us with a better brainmask. The
<code>bet</code> command above is called to output only the binary mask
and the fractional intensity threshold is also increased slightly (to
0.6) provide a smaller outline of the brain initially, and then
decreased (to 0.4) to provide a larger outline. The flag <code>-m</code>
indicates to the tool to create a brainmask in addition to outputting
the extracted brain volume. Both the mask and brain volume will be used
in our registration step.</p>
<p>Before we get to the registration, we will also update our DWI
brainmask by performing a brain extraction using <code>DIPY</code> on
the eddy corrected image. Note that the output of <code>eddy</code> is
not in BIDS format so we will include the path to the diffusion data
manually. We will save both the brainmask and the extracted brain
volume. Additionally, we will save a separate volume of only the first
B0 to use for the registration.</p>
<div class="codewrapper sourceCode" id="cb10">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="im">from</span> dipy.segment.mask <span class="im">import</span> median_otsu</span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a><span class="co"># Path of FSL eddy-corrected dwi</span></span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a>dwi <span class="op">=</span> <span class="st">"../../data/ds000221/derivatives/uncorrected_topup_eddy/sub-010006/ses-01/dwi/dwi.nii.gz"</span></span>
<span id="cb10-5"><a href="#cb10-5" tabindex="-1"></a></span>
<span id="cb10-6"><a href="#cb10-6" tabindex="-1"></a><span class="co"># Load eddy-corrected diffusion data</span></span>
<span id="cb10-7"><a href="#cb10-7" tabindex="-1"></a>dwi <span class="op">=</span> nib.load(dwi)</span>
<span id="cb10-8"><a href="#cb10-8" tabindex="-1"></a>dwi_affine <span class="op">=</span> dwi.affine</span>
<span id="cb10-9"><a href="#cb10-9" tabindex="-1"></a>dwi_data <span class="op">=</span> dwi.get_fdata()</span>
<span id="cb10-10"><a href="#cb10-10" tabindex="-1"></a></span>
<span id="cb10-11"><a href="#cb10-11" tabindex="-1"></a>dwi_brain, dwi_mask <span class="op">=</span> median_otsu(dwi_data, vol_idx<span class="op">=</span>[<span class="dv">0</span>])</span>
<span id="cb10-12"><a href="#cb10-12" tabindex="-1"></a>dwi_b0 <span class="op">=</span> dwi_brain[:,:,:,<span class="dv">0</span>]</span>
<span id="cb10-13"><a href="#cb10-13" tabindex="-1"></a></span>
<span id="cb10-14"><a href="#cb10-14" tabindex="-1"></a><span class="co"># Output directory</span></span>
<span id="cb10-15"><a href="#cb10-15" tabindex="-1"></a>out_dir<span class="op">=</span><span class="st">"../../data/ds000221/derivatives/uncorrected_topup_eddy/sub-010006/ses-01/dwi"</span></span>
<span id="cb10-16"><a href="#cb10-16" tabindex="-1"></a></span>
<span id="cb10-17"><a href="#cb10-17" tabindex="-1"></a><span class="co"># Save diffusion mask</span></span>
<span id="cb10-18"><a href="#cb10-18" tabindex="-1"></a>img <span class="op">=</span> nib.Nifti1Image(dwi_mask.astype(np.float32), dwi_affine)</span>
<span id="cb10-19"><a href="#cb10-19" tabindex="-1"></a>nib.save(img, os.path.join(out_dir, <span class="st">"sub-010006_ses-01_dwi_proc-eddy_brainmask.nii.gz"</span>))</span>
<span id="cb10-20"><a href="#cb10-20" tabindex="-1"></a></span>
<span id="cb10-21"><a href="#cb10-21" tabindex="-1"></a><span class="co"># Save 4D diffusion volume</span></span>
<span id="cb10-22"><a href="#cb10-22" tabindex="-1"></a>img <span class="op">=</span> nib.Nifti1Image(dwi_brain, dwi_affine)</span>
<span id="cb10-23"><a href="#cb10-23" tabindex="-1"></a>nib.save(img, os.path.join(out_dir, <span class="st">"sub-010006_ses-01_dwi_proc-eddy_brain.nii.gz"</span>))</span>
<span id="cb10-24"><a href="#cb10-24" tabindex="-1"></a></span>
<span id="cb10-25"><a href="#cb10-25" tabindex="-1"></a><span class="co"># Save b0 volume</span></span>
<span id="cb10-26"><a href="#cb10-26" tabindex="-1"></a>img <span class="op">=</span> nib.Nifti1Image(dwi_b0, dwi_affine)</span>
<span id="cb10-27"><a href="#cb10-27" tabindex="-1"></a>nib.save(img, os.path.join(out_dir, <span class="st">"sub-010006_ses-01_dwi_proc-eddy_b0.nii.gz"</span>))</span></code></pre>
</div>
<p>To perform the registration between the diffusion volumes and T1w, we
will make use of <code>ANTs</code>, specifically the
<code>antsRegistrationSyNQuick.sh</code> script and
<code>antsApplyTransform</code>. We will begin by registering the
diffusion <span class="math inline">\(b = 0 s/mm^2\)</span> volume to
get the appropriate transforms to align the two images. We will then
apply the inverse transformation to the T1w volume such that it is
aligned to the diffusion volume.</p>
<p>Here, we will constrain <code>antsRegistrationSyNQuick.sh</code> to
perform a rigid and affine transformation (we will explain why in the
final step). There are a few parameters that must be set:</p>
<ul><li>
<code>-d</code> - Image dimension (2/3D).</li>
<li>
<code>-t</code> - Transformation type (<code>a</code> performs only
rigid + affine transformation).</li>
<li>
<code>-f</code> - Fixed image (anatomical T1w).</li>
<li>
<code>-m</code> - Moving image (B0 DWI volume).</li>
<li>
<code>-o</code> - Output prefix (prefix to be appended to output
files).</li>
</ul><div class="codewrapper sourceCode" id="cb11">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="fu">mkdir</span> <span class="at">-p</span> ../../data/ds000221/derivatives/uncorrected_topup_eddy_regT1/sub-010006/ses-01/transforms</span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a><span class="co"># Perform registration between b0 and T1w</span></span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a><span class="ex">antsRegistrationSyNQuick.sh</span> <span class="at">-d</span> 3 <span class="at">-t</span> a <span class="at">-f</span> ../../data/ds000221/derivatives/uncorrected/sub-010006/ses-01/anat/sub-010006_ses-01_space-T1w_brain.nii.gz <span class="at">-m</span> ../../data/ds000221/derivatives/uncorrected_topup_eddy/sub-010006/ses-01/dwi/sub-010006_ses-01_dwi_proc-eddy_b0.nii.gz <span class="at">-o</span> ../../data/ds000221/derivatives/uncorrected_topup_eddy_regT1/sub-010006/ses-01/transform/dwi_to_t1_</span></code></pre>
</div>
<p>The transformation file should be created which we will use to apply
the inverse transform with <code>antsApplyTransform</code> to the T1w
volume. Similar to the previous command, there are few parameters that
will need to be set:</p>
<ul><li>
<code>-d</code> - Image dimension (2/3/4D).</li>
<li>
<code>-i</code> - Input volume to be transformed (T1w).</li>
<li>
<code>-r</code> - Reference volume (B0 DWI volume).</li>
<li>
<code>-t</code> - Transformation file (can be called more than
once).</li>
<li>
<code>-o</code> - Output volume in the transformed space.</li>
</ul><p>Note that if more than 1 transformation file is provided, the order
in which the transforms are applied to the volume is in reverse order of
how it is inputted (e.g. last transform gets applied first).</p>
<div class="codewrapper sourceCode" id="cb12">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="co"># Apply transform to 4D DWI volume</span></span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a><span class="ex">antsApplyTransforms</span> <span class="at">-d</span> 3 <span class="at">-i</span> ../../data/ds000221/derivatives/uncorrected/sub-010006/ses-01/anat/sub-010006_ses-01_space-T1w_brain.nii.gz <span class="at">-r</span> ../../data/ds000221/derivatives/uncorrected_topup_eddy/sub-010006/ses-01/dwi/sub-010006_ses-01_dwi_proc-eddy_b0.nii.gz <span class="at">-t</span> <span class="pp">[</span><span class="ss">../../data/ds000221/derivatives/uncorrected_topup_eddy_regT1/sub</span><span class="pp">-</span><span class="ss">010006/ses</span><span class="pp">-</span><span class="ss">01/transform/dwi_to_t1_0GenericAffine.mat,1</span><span class="pp">]</span> <span class="at">-o</span> ../../data/ds000221/derivatives/uncorrected_topup_eddy_regT1/sub-010006/ses-01/anat/sub-010006_ses-01_space-dwi_T1w_brain.nii.gz</span></code></pre>
</div>
<figure><img src="../fig/preprocessing/transformed_volumes.png" alt="Transformed volumes" class="figure mx-auto d-block"></figure><p>Following the transformation of the T1w volume, we can see that
anatomical and diffusion weighted volumes are now aligned. It should be
highlighted that as part of the transformation step, the T1w volume is
resampled based on the voxel size of the reference volume (i.e. the B0
DWI volume in this case).</p>
</div>
<div class="section level3">
<h3 id="preprocessing-notes">Preprocessing notes:<a class="anchor" aria-label="anchor" href="#preprocessing-notes"></a></h3>
<ol style="list-style-type: decimal"><li>In this lesson, the T1w volume is registered to the DWI volume. This
method minimizes the manipulation of the diffusion data. It is also
possible to register the DWI volume to the T1w volume and would require
the associated diffusion gradient vectors (bvec) to also be similarly
rotated. If this step is not performed, one would have incorrect
diffusion gradient directions relative to the registered DWI volumes.
This also highlights a reason behind not performing a non-linear
transformation for registration, as each individual diffusion gradient
direction would also have to be subsequently warped. Rotation of the
diffusion gradient vectors can be done by applying the affine
transformation to each row of the file. Luckily, there are existing
scripts that can do this. One such Python script was created by Michael
Paquette: <a href="https://gist.github.com/mpaquette/5d59ad195778f9d984c5def42f53de6e" class="external-link"><code>rot_bvecs_ants.py</code></a>.</li>
<li>We have only demonstrated the preprocessing steps where there is
general consensus on how DWI data should be processed. There are also
additional steps with certain caveats, which include denoising,
unringing (to remove/minimize effects of Gibbs ringing artifacts), and
gradient non-linearity correction (to unwarp distortions caused by
gradient-field inhomogeneities using a vendor acquired gradient
coefficient file).</li>
<li>Depending on how the data is acquired, certain steps may not be
possible. For example, if the data is not acquired in two directions,
<code>topup</code> may not be possible (in this situation, distortion
correction may be better handled by registering with a T1w anatomical
image directly.</li>
<li>There are also a number of tools available for preprocessing. In
this lesson, we demonstrate some of the more commonly used tools
alongside <code>DIPY</code>.</li>
</ol></div>
<div class="section level3">
<h3 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a></h3>
<p>.. [Cieslak2020] M. Cieslak, PA. Cook, X. He, F-C. Yeh, T.
Dhollander, <em>et al</em>, “QSIPrep: An integrative platform for
preprocessing and reconstructing diffusion MRI”, <a href="https://doi.org/10.1101/2020.09.04.282269" class="external-link">https://doi.org/10.1101/2020.09.04.282269</a></p>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points</h3>
<div class="callout-content">
<ul><li>Many different preprocessing pipelines, dependent on how data is
acquired</li>
</ul></div>
</div>
</div>
<!-- Workshop-specific links -->
</div>
</section></div> <!-- / div.lesson-content -->
    </main><!-- / main#main-content.main-content --><nav class="bottom-pagination mx-md-4" aria-label="Previous and Next Chapter"><div class="d-block d-sm-block d-md-none">
        <a class="chapter-link" href="../instructor/introduction.html"><i aria-hidden="true" class="small-arrow" data-feather="arrow-left"></i>Previous</a>
        <a class="chapter-link float-end" href="../instructor/local_orientation_reconstruction.html">Next<i aria-hidden="true" class="small-arrow" data-feather="arrow-right"></i></a>
      </div>
      <!-- content for large screens -->
      <div class="d-none d-sm-none d-md-block">
        <a class="chapter-link" href="../instructor/introduction.html" rel="prev">
          <i aria-hidden="true" class="small-arrow" data-feather="arrow-left"></i>
          Previous: Introduction to
        </a>
        <a class="chapter-link float-end" href="../instructor/local_orientation_reconstruction.html" rel="next">
          Next: Local fiber...
          <i aria-hidden="true" class="small-arrow" data-feather="arrow-right"></i>
        </a>
      </div>
    </nav></div> <!-- / div.primary-content.col-xs-12 -->
<!-- END:   inst/pkgdown/templates/content-instructor.html-->

      </div><!--/div.row-->
      		<footer class="row footer mx-md-3"><hr><div class="col-md-6">
        <p>This lesson is subject to the <a href="CODE_OF_CONDUCT.html">Code of Conduct</a></p>
        <p>

        <a href="https://github.com/carpentries-incubator/SDC-BIDS-dMRI/edit/main/episodes/preprocessing.md" class="external-link">Edit on GitHub</a>

	
        | <a href="https://github.com/carpentries-incubator/SDC-BIDS-dMRI/blob/main/CONTRIBUTING.md" class="external-link">Contributing</a>
        | <a href="https://github.com/carpentries-incubator/SDC-BIDS-dMRI/" class="external-link">Source</a></p>
				<p><a href="https://github.com/carpentries-incubator/SDC-BIDS-dMRI/blob/main/CITATION" class="external-link">Cite</a> | <a href="mailto:team@carpentries.org">Contact</a> | <a href="https://carpentries.org/about/" class="external-link">About</a></p>
			</div>
			<div class="col-md-6">

        <p>Materials licensed under <a href="LICENSE.html">CC-BY 4.0</a> by the authors</p>

        <p>Template licensed under <a href="https://creativecommons.org/licenses/by-sa/4.0/" class="external-link">CC-BY 4.0</a> by <a href="https://carpentries.org/" class="external-link">The Carpentries</a></p>
        <p>Built with <a href="https://github.com/carpentries/sandpaper/tree/0.16.10" class="external-link">sandpaper (0.16.10)</a>, <a href="https://github.com/carpentries/pegboard/tree/0.7.7" class="external-link">pegboard (0.7.7)</a>, and <a href="https://github.com/carpentries/varnish/tree/1.0.5" class="external-link">varnish (1.0.5)</a></p>
			</div>
		</footer></div> <!-- / div.container -->
	<div id="to-top">
		<a href="#top">
      <i class="search-icon" data-feather="arrow-up" role="img" aria-label="Back To Top"></i><br><!-- <span class="d-none d-sm-none d-md-none d-lg-none d-xl-block">Back</span> To Top --><span class="d-none d-sm-none d-md-none d-lg-none d-xl-block">Back</span> To Top
		</a>
	</div>
  <script type="application/ld+json">
    {
  "@context": "https://schema.org",
  "@type": "TrainingMaterial",
  "@id": "https://carpentries-incubator.github.io/SDC-BIDS-dMRI/instructor/preprocessing.html",
  "inLanguage": "en",
  "dct:conformsTo": "https://bioschemas.org/profiles/TrainingMaterial/1.0-RELEASE",
  "description": "A Carpentries Lesson teaching foundational data and coding skills to researchers worldwide",
  "keywords": "software, data, lesson, The Carpentries",
  "name": "Preprocessing dMRI data",
  "creativeWorkStatus": "active",
  "url": "https://carpentries-incubator.github.io/SDC-BIDS-dMRI/instructor/preprocessing.html",
  "identifier": "https://carpentries-incubator.github.io/SDC-BIDS-dMRI/instructor/preprocessing.html",
  "dateCreated": "2024-10-22",
  "dateModified": "2024-02-18",
  "datePublished": "2025-01-14"
}

  </script><script>
		feather.replace();
	</script><!-- Matomo --><script>
          var _paq = window._paq = window._paq || [];
          /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
          _paq.push(["setDocumentTitle", document.domain + "/" + document.title]);
          _paq.push(["setDomains", ["*.lessons.carpentries.org","*.datacarpentry.github.io","*.datacarpentry.org","*.librarycarpentry.github.io","*.librarycarpentry.org","*.swcarpentry.github.io", "*.carpentries.github.io"]]);
          _paq.push(["setDoNotTrack", true]);
          _paq.push(["disableCookies"]);
          _paq.push(["trackPageView"]);
          _paq.push(["enableLinkTracking"]);
          (function() {
              var u="https://matomo.carpentries.org/";
              _paq.push(["setTrackerUrl", u+"matomo.php"]);
              _paq.push(["setSiteId", "1"]);
              var d=document, g=d.createElement("script"), s=d.getElementsByTagName("script")[0];
              g.async=true; g.src="https://matomo.carpentries.org/matomo.js"; s.parentNode.insertBefore(g,s);
          })();
        </script><!-- End Matomo Code --></body></html><!-- END:   inst/pkgdown/templates/layout.html-->

